---
git:
  branch: main
  commit: 7297133
  dirty: true
  files_changed:
  - .memories/plans/plan_replace-fts5-with-tantivy-codetokenizer.json
  - crates/julie-extractors/src/factory.rs
  - crates/julie-extractors/src/gdscript/mod.rs
  - crates/julie-extractors/src/manager.rs
  - crates/julie-extractors/src/ruby/mod.rs
  - crates/julie-extractors/src/tests/gdscript/mod.rs
  - crates/julie-extractors/src/tests/ruby/mod.rs
  - src/search/index.rs
  - src/search/query.rs
  - src/tests/integration/watcher.rs
  - src/tests/integration/watcher_handlers.rs
  - src/tests/mod.rs
  - src/tests/tools/search/tantivy_index_tests.rs
  - src/tools/workspace/indexing/mod.rs
  - src/tools/workspace/indexing/processor.rs
  - src/tools/workspace/mod.rs
  - src/watcher/handlers.rs
  - src/watcher/mod.rs
  - src/workspace/mod.rs
id: checkpoint_698548a9_172da1
tags:
- bug
- search
- tantivy
- query
timestamp: 1770342569
type: checkpoint
---

Fixed Tantivy definition search false positives (Task #12). Three coordinated changes:

1. **build_symbol_query** (query.rs): Changed from flat OR across all terms to AND-per-term — each search token must match in at least one field (name/sig/doc/body), and ALL tokens must be present. Eliminates false positives from partial token matches.

2. **build_content_query** (query.rs): Same AND-per-term logic for content search.

3. **filter_compound_tokens** (index.rs): New helper removes snake_case compound tokens whose sub-parts are all present in the token list. Prevents AND from requiring partial compounds (e.g., "search_term") that are never produced when indexing longer names (e.g., "search_term_one"). The CodeTokenizer emits full_form + atomic_parts but never partial compounds.

Root cause: CodeTokenizer produces [full_form, part1, part2, ...] for both indexing AND querying. When querying "search_term", it produces ["search_term", "search", "term"]. But when indexing "search_term_one", it produces ["search_term_one", "search", "term", "one"] — no "search_term" token. AND logic on the raw tokenizer output would require the non-existent "search_term" token.

Tests: 727 pass, 0 new failures. Regression test (test_multi_token_search_requires_all_tokens) validates false positive elimination. All 6 text_search_tantivy integration tests pass including previously-broken test_text_search_respects_limit.
