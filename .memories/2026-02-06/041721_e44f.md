---
git:
  branch: main
  commit: 7c18e80
  dirty: true
  files_changed:
  - .memories/plans/plan_phase-3-priority-1-fast-search-improvements.json
  - src/database/helpers.rs
  - src/database/symbols/queries.rs
  - src/tests/mod.rs
  - src/tools/symbols/filtering.rs
  - src/tools/symbols/formatting.rs
  - src/tools/symbols/mod.rs
  - src/tools/symbols/primary.rs
  - src/tools/symbols/reference.rs
id: checkpoint_69856b51_802c9b
tags:
- refactor
- performance
- filtering
- get_symbols
- zero-clone
timestamp: 1770351441
type: checkpoint
---

Refactored filter pipeline in filtering.rs to index-based single-clone architecture.

BEFORE: apply_all_filters() cloned Vec<Symbol> up to 3 times — once per filter stage (max_depth, target, limit). Each Symbol has ~20 fields including 12+ Strings, causing ~380 unnecessary clones for a 200-symbol file.

AFTER: All three filter stages now operate on Vec<usize> indices into the original array. A single clone happens at the end of apply_all_filters(). Eliminated 2 of 3 full-Vec clones (~4,800 avoided heap allocations for 200 symbols).

Key changes:
- Added internal index-returning functions: max_depth_indices(), target_indices(), limit_indices()
- Added *_within variants (add_descendants_within, add_all_descendants_within) that accept allowed-set filter for candidate restriction
- Removed dead code: old add_descendants() and add_all_descendants() (replaced by _within variants)
- Per-stage public functions (apply_max_depth_filter, apply_target_filter, apply_limit_filter) gated behind #[cfg(test)]
- Public API of apply_all_filters() unchanged — callers in primary.rs and reference.rs unaffected

Tests: 22 new tests in src/tests/tools/filtering_tests.rs covering all filter stages and edge cases. 761 lib tests pass, 0 failures.
