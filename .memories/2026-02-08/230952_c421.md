---
git:
  branch: main
  commit: 23537b4
  dirty: true
  files_changed:
  - .memories/plans/plan_extractor-round-3-quality-improvements.json
  - TODO.md
  - src/tests/tools/search/line_mode.rs
  - src/tools/search/line_mode.rs
  - src/tools/search/text_search.rs
id: checkpoint_698917c0_3de2b8
tags:
- search
- file_pattern
- bug-fix
- line_mode
- text_search
- filter-before-limit
timestamp: 1770592192
type: checkpoint
---

## Fix file_pattern Filtering in fast_search — All Search Paths

### Root Cause
`file_pattern` was applied as a **post-filter after results were already capped by `limit`**. If none of the globally top-ranked Tantivy results happened to be in target files, zero results were returned.

### Three Bugs Fixed

1. **`line_mode.rs` (content search)**: `file_pattern` AND `language` were hardcoded to `None` in SearchFilter — parameters thrown away before Tantivy search
2. **`text_search.rs` (definition search)**: `file_pattern` in SearchFilter but ignored by `build_symbol_query()` — post-filter after limit cap
3. **`text_search.rs` (content search via ref workspace)**: Same post-filter-after-limit pattern

### Fix Applied
- When `file_pattern` is set, increase Tantivy `fetch_limit` (100x for content, 50x for definitions)
- Apply glob filtering **INSIDE** collection loops, **BEFORE** counting toward user's limit
- Keep existing post-filter as defense-in-depth (now a no-op)
- Pass `language` to SearchFilter in line_mode (was `None`)
- Extract `file_matches_language()` helper from inline closure

### Files Changed
- `src/tools/search/line_mode.rs` — Primary fix (content search path)
- `src/tools/search/text_search.rs` — Secondary fix (definitions + ref workspace)
- `src/tests/tools/search/line_mode.rs` — Un-ignored 2 tests that were misattributed to "FTS timing issue"

### Tests
- **121 passed, 0 failed** across search test suite
- 2 previously `#[ignore]`d tests now passing
- All glob regression tests still green
