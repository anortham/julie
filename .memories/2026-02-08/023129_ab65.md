---
git:
  branch: main
  commit: 850aee6
  dirty: true
  files_changed:
  - TODO.md
  - src/database/bulk_operations.rs
  - src/database/files.rs
  - src/database/symbols/bulk.rs
id: checkpoint_6987f581_e4d2b9
tags:
- wal
- sqlite
- bug-fix
- disk-usage
timestamp: 1770517889
type: checkpoint
---

## WAL File Bloat Fix — RESTART → TRUNCATE

### Root Cause
SQLite WAL file (75MB) was as large as the database (74MB) because bulk operations used `RESTART` checkpoint mode which resets the write position but **never shrinks the file on disk**. Only `TRUNCATE` mode actually truncates the WAL to 0 bytes.

### What Changed
Replaced all 4 `pragma_update(None, "wal_checkpoint", "RESTART")` calls with proper `PRAGMA wal_checkpoint(TRUNCATE)` prepared statements:
- `src/database/symbols/bulk.rs` — after bulk symbol store
- `src/database/files.rs` — after bulk file store
- `src/database/bulk_operations.rs` (2 sites) — after bulk identifier and type stores

### Also Fixed
- **`pragma_update` misuse**: `rusqlite::execute()` returns `Err(ExecuteReturnedResults)` for result-returning pragmas like `wal_checkpoint`. The checkpoint still happened but was always logged as "failed." Now using `prepare()/query_row()` which correctly reads the `(busy, log, checkpointed)` result tuple.

### Verification
- 653 lib tests pass, 0 failures
- WAL checkpoint tests pass
- Bulk storage atomicity tests pass
- Zero remaining `pragma_update` + `wal_checkpoint` calls in src/
