---
git:
  branch: main
  commit: d0edc3b
  dirty: true
  files_changed:
  - crates/julie-extractors/src/razor/html.rs
  - crates/julie-extractors/src/razor/mod.rs
  - crates/julie-extractors/src/razor/relationships.rs
  - crates/julie-extractors/src/tests/razor/mod.rs
id: checkpoint_69876301_570806
tags:
- razor
- blazor
- regex-primary
- component-detection
- tree-sitter-workaround
timestamp: 1770480385
type: checkpoint
---

## Razor Component Detection: Regex-Primary Approach

### Problem
Components that tree-sitter-razor misparsed were invisible when not inside any `element` node. Example: `@Body` followed by `<TopLevelPanel />` at the top level — tree-sitter sees `Body < TopLevelPanel` (C# comparison), and no `element` node wraps it, so the per-element regex fallback never runs.

### Solution
Replaced per-element regex fallback (`create_external_component_symbols_if_needed`) with a **whole-source regex pass** (`extract_template_components`) that runs after the tree-sitter walk.

### Changes
- **`html.rs`**: Replaced `create_external_component_symbols_if_needed()` with `extract_template_components(tree, symbols)`
  - Scans `self.base.content` for `<([A-Z][A-Za-z0-9]+)` matches
  - Uses `tree.root_node().descendant_for_byte_range()` for position info
  - Creates `blazor-component` symbols with `source: \"template-scan\"` metadata
  - Dedup: skips if symbol with same name already exists
- **`mod.rs`**: Added `self.extract_template_components(tree, &mut symbols)` call in `extract_symbols()` after `visit_node()`
- **`mod.rs`**: Removed `create_external_component_symbols_if_needed()` from both `element` and `razor_component` match arms
- **Tests**: Added `test_component_after_razor_expression_detected` — validates top-level component after `@Body` is found

### Test Results
- 27 Razor tests pass (was 26, +1 new)
- 1125 extractor tests pass (was 1124, +1 new)
- 758 full lib tests pass, 0 failures (2 flaky real_world tests passed on re-run)

### Confidence: ~70/100
Up from 55. The whole-source regex catches ALL PascalCase tags regardless of tree-sitter parse quality. Tree-sitter still handles directives and C# code well. Main remaining gaps: imprecise relationship from-symbols, no `@rendermode` support, limited test coverage of advanced Blazor patterns.
